<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Çark</title>
<link rel="stylesheet" href="../style.css">

<style>
html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;

  overflow: hidden;        /* yukarı-aşağı + sağ-sol kilit */
  overflow-x: hidden;
  overflow-y: hidden;

  touch-action: manipulation; /* mobilde zoom engelle */
  overscroll-behavior: none;  /* lastik efekti kapat */
}
body {
  font-family: Arial;
  margin: 0;
  padding: 10px;
  background: var(--bggenel);
  text-align: center;
  background-color: red;
}

/* ÜST BUTONLAR */
#topControls {
  display: flex;
  justify-content: center; /* Yatayda ortalar */
  align-items: center;     /* Dikeyde hizalar */
  gap: 8px;                /* Butonlar arası boşluk */
  margin: 10px 0;          /* Üstten ve alttan biraz boşluk */
  width: 100%;             /* Alanın tamamını kaplamasını sağla */
}
button {
  padding: 8px 12px;
  font-size: 14px;
  border: none;
  border-radius: 6px;
  background: #4d79ff;
  color: white;
  cursor: pointer;
  white-space: nowrap; /* Metnin alt satıra geçmesini engeller */
}
button:hover { background: #3650b3; }

/* ÇARK ALANI */
#wheelContainer {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 10px;        /* butonların altı */
}

/* CANVAS */
canvas {
  margin: 0;
  display: block;
}

/* OK */
#pointer {
  position: absolute;
  top: -18px;
  left: 50%;
  width: 0;
  height: 0;
  border-left: 14px solid transparent;
  border-right: 14px solid transparent;
  border-bottom: 28px solid black;
  transform: translateX(-50%) rotate(180deg);
  z-index: 10;
}

/* SONUÇ YAZISI */
#resultLabel {
  margin-top: 20px;
  font-size: 22px;
  font-weight: bold;
}

/* OVERLAY */
.overlay {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
}

.overlay-content {
  background: white;
  padding: 15px;
  border-radius: 10px;
  width: 90%;
  max-width: 420px;
  max-height: 90%;
  overflow-y: auto;
}

.segment-input {
  display: flex;
  gap: 5px;
  align-items: center;
  margin-bottom: 6px;
}

.color-preview {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 1px solid #333;
}

/* ÇARK LİSTESİ */
#wheelList > div {
  background: #eee;
  padding: 8px;
  margin-bottom: 6px;
  border-radius: 8px;
}
</style>
</head>
<body>

<div id="topControls">
  <button id="spin">Çevir</button>
  <button id="newWheelBtn">Yeni Çark</button>
  <button id="showWheelListBtn">Çark Listesi</button>
  <button onclick="goMenu()">Ana Menü</button>
</div>

<div id="wheelContainer">
  <div id="pointer"></div>
  <canvas id="wheel"></canvas>
</div>

<!-- SONUÇ LABEL -->
<div id="resultLabel"></div>

<!-- YENİ ÇARK PANELİ -->
<div class="overlay" id="wheelOverlay">
  <div class="overlay-content">
    <h3>Yeni / Düzenle</h3>

    <label>Çark İsmi:</label>
    <input type="text" id="wheelName">

    <label>Bölüm Sayısı:</label>
    <input type="number" id="segmentCount" min="2" max="12" value="3">

    <div id="segmentsContainer"></div>

    <button id="saveWheelBtn">Kaydet</button>
    <button id="cancelOverlayBtn" style="background:#ccc;color:#000;">İptal</button>
  </div>
</div>

<!-- ÇARK LİSTESİ PANELİ -->
<div class="overlay" id="listOverlay">
  <div class="overlay-content">
    <h3>Mevcut Çarklar</h3>
    <div id="wheelList"></div>
    <button id="closeListOverlay" style="background:#ccc;color:#000;">Kapat</button>
  </div>
</div>

<script>
/* === CANVAS === */
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");

let segments = [];
let angle = 0;
let spinning = false;
let editingIndex = null;
let center, radius;

/* CANVAS BOYUTLAMA */
function resizeCanvas() {
  const size = Math.min(window.innerWidth - 20, 360);
  canvas.width = size;
  canvas.height = size;

  radius = size / 2;
  center = radius;

  drawWheel();
}
window.addEventListener("resize", resizeCanvas);

/* === ÇARK ÇİZ === */
function drawWheel() {
  if (!segments.length) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const arc = (2 * Math.PI) / segments.length;

  segments.forEach((seg, i) => {
    const start = angle + i * arc;
    const end = start + arc;

    ctx.beginPath();
    ctx.moveTo(center, center);
    ctx.arc(center, center, radius, start, end);
    ctx.fillStyle = seg.color;
    ctx.fill();
    ctx.stroke();

    ctx.save();
    ctx.translate(center, center);
    ctx.rotate(start + arc / 2);
    ctx.textAlign = "right";
    ctx.fillStyle = "#fff";
    ctx.font = `${radius / 12}px Arial`;
    ctx.fillText(seg.text, radius - 20, 5);
    ctx.restore();
  });
}

/* === SPİN === */
function spinWheel() {
  if (spinning) return;
  spinning = true;

  let speed = Math.random() * 0.25 + 0.25;
  const friction = 0.992;

  function animate() {
    angle += speed;
    speed *= friction;
    drawWheel();

    if (speed > 0.002) {
      requestAnimationFrame(animate);
    } else {
      spinning = false;
      findWinner();
    }
  }
  animate();
}

/* === KAZANANI BUL === */
function findWinner() {
  const arc = (2 * Math.PI) / segments.length;
  let pointerAngle = -Math.PI / 2;

  let a = (pointerAngle - angle) % (2 * Math.PI);
  if (a < 0) a += 2 * Math.PI;

  let index = Math.floor(a / arc);

  document.getElementById("resultLabel").textContent =
    "Kazanan: " + segments[index].text;
}

/* === LOCAL STORAGE === */
function loadWheels() {
  const d = localStorage.getItem("wheels");
  return d ? JSON.parse(d) : [];
}
function saveWheels(w) {
  localStorage.setItem("wheels", JSON.stringify(w));
}

/* === BÖLÜM INPUTLARI === */
function createInputs(count, data = []) {
  const c = document.getElementById("segmentsContainer");
  c.innerHTML = "";

  count = Math.min(count, 12);
  document.getElementById("segmentCount").value = count;

  for (let i = 0; i < count; i++) {
    const text = data[i]?.text || `Bölüm ${i+1}`;
    const color = data[i]?.color || "#"+Math.floor(Math.random()*16777215).toString(16);

    c.insertAdjacentHTML("beforeend", `
      <div class="segment-input">
        <input type="text" class="segText" value="${text}">
        <input type="color" class="segColor" value="${color}">
        <div class="color-preview" style="background:${color}"></div>
      </div>
    `);
  }

  document.querySelectorAll(".segColor").forEach((input, i) => {
    input.addEventListener("input", () => {
      document.querySelectorAll(".color-preview")[i].style.background = input.value;
    });
  });
}

/* === OVERLAY İŞLEMLERİ === */
function openOverlay(data = null, index = null) {
  editingIndex = index;
  document.getElementById("wheelName").value = data?.name || "";
  const count = data ? data.segments.length : 3;
  document.getElementById("segmentCount").value = count;
  createInputs(count, data ? data.segments : []);
  document.getElementById("wheelOverlay").style.display = "flex";
}
function closeOverlay() {
  document.getElementById("wheelOverlay").style.display = "none";
}

function openListOverlay() {
  const list = document.getElementById("wheelList");
  const wheels = loadWheels();
  list.innerHTML = "";

  wheels.forEach((w, i) => {
    list.insertAdjacentHTML("beforeend", `
      <div>
        <b>${w.name}</b> (${w.segments.length} bölüm)
        <div style="margin-top:5px;">
          <button onclick="selectWheel(${i})" style="background:#2196F3">Seç</button>
          <button onclick="editWheel(${i})" style="background:#4CAF50">Düzenle</button>
          <button onclick="deleteWheel(${i})" style="background:#F44336">Sil</button>
        </div>
      </div>
    `);
  });

  document.getElementById("listOverlay").style.display = "flex";
}
function closeListOverlay() {
  document.getElementById("listOverlay").style.display = "none";
}

function selectWheel(i) {
  segments = loadWheels()[i].segments;
  drawWheel();
  closeListOverlay();
}
function editWheel(i) {
  openOverlay(loadWheels()[i], i);
  closeListOverlay();
}
function deleteWheel(i) {
  const wheels = loadWheels();
  wheels.splice(i, 1);
  saveWheels(wheels);
  openListOverlay();
}

/* === EVENTLER === */
document.getElementById("newWheelBtn").onclick = () => openOverlay();
document.getElementById("cancelOverlayBtn").onclick = closeOverlay;
document.getElementById("showWheelListBtn").onclick = openListOverlay;
document.getElementById("closeListOverlay").onclick = closeListOverlay;

document.getElementById("segmentCount").onchange = e => {
  let v = +e.target.value;
  if (v > 12) v = 12;
  createInputs(v);
};

document.getElementById("saveWheelBtn").onclick = () => {
  const name = document.getElementById("wheelName").value || "Çark";
  const texts = [...document.querySelectorAll(".segText")];
  const colors = [...document.querySelectorAll(".segColor")];

  const segs = texts.map((t, i) => ({ text: t.value, color: colors[i].value }));

  const wheels = loadWheels();
  if (editingIndex != null) wheels[editingIndex] = { name, segments: segs };
  else wheels.push({ name, segments: segs });

  saveWheels(wheels);
  segments = segs;
  drawWheel();
  closeOverlay();
};

document.getElementById("spin").onclick = spinWheel;

/* === INIT === */
resizeCanvas();
/*---------------TEMA------------------*/
function setTheme(theme) {
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("theme", theme);

  if (theme === "light") {
    const savedBg = localStorage.getItem("lightBg");
    if (savedBg) {
      document.documentElement.style.setProperty("--bggenel", savedBg);
    }
  } else {
    document.documentElement.style.removeProperty("--bggenel");
  }
}

// sayfa açılınca
window.addEventListener("DOMContentLoaded", () => {
  const theme = localStorage.getItem("theme") || "dark";
  document.documentElement.setAttribute("data-theme", theme);

  if (theme === "light") {
    const savedBg = localStorage.getItem("lightBg");
    if (savedBg) {
      document.documentElement.style.setProperty("--bggenel", savedBg);
    }
  }
});

// light tema arka planı
function setLightBg(color) {
  document.documentElement.style.setProperty("--bggenel", color);
  localStorage.setItem("lightBg", color);
}
window.addEventListener("DOMContentLoaded", () => {
  const theme = localStorage.getItem("theme") || "dark";
  document.documentElement.setAttribute("data-theme", theme);

  if (theme === "dark") {
    // DARK ise XOX arka planı sabitle
    document.documentElement.style.setProperty("--bggenel", "#0f1724");
  } else {
    // LIGHT ise seçilen light rengini kullan
    const savedBg = localStorage.getItem("lightBg");
    if (savedBg) {
      document.documentElement.style.setProperty("--bggenel", savedBg);
    }
  }
});

  function goMenu() {
    window.location.href = "../../index.html"; 
}
</script>

</body>
</html>
